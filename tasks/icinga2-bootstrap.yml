---
# When a --limit is in place only the facts of
# the selected hosts are retrieved and we need
# the facts of the other nodes as they are
# used as defaults of variables used in the
# templates
- name: Gather Facts of the other Icinga nodes
  setup:
  run_once: True
  delegate_facts: True
  delegate_to: "{{ item }}"
  loop: >-
    {{ groups[i2_master_group]|default([])
    + groups[i2_satellite_group]|default([])
    + groups[i2_agent_group]|default([]) }}
  when: hostvars[item].ansible_fqdn is not defined

 # Copying role-vars to host-vars
 # We do this in a loop over all the nodes as we
 # need the variables of other nodes in the templates
 # which we don't get if a --limit is in place
- name: Set default hostvars for Icinga masters
  set_fact:
    i2_master: >-
      {{ hostvars[item].i2_master|default(True) }}
    i2_satellite: >-
      {{ hostvars[item].i2_satellite|default(False) }}
  run_once: True
  delegate_facts: True
  delegate_to: "{{ item }}"
  loop: "{{ groups[i2_master_group]|default([]) }}"

- name: Set default hostvars for Icinga satellites
  set_fact:
    i2_master: >-
      {{ hostvars[item].i2_master|default(False) }}
    i2_satellite: >-
      {{ hostvars[item].i2_satellite|default(True) }}
    i2_parent_zone: >-
      {{ hostvars[item].i2_parent_zone|default('master') }}
  run_once: True
  delegate_facts: True
  delegate_to: "{{ item }}"
  loop: "{{ groups[i2_satellite_group]|default([]) }}"

- name: Set default hostvars for all Icinga nodes
  set_fact:
    i2_address: >-
      {{ hostvars[item].i2_address|default(hostvars[item].ansible_facts.default_ipv4.address) }}
    i2_api_port: >-
      {{ hostvars[item].i2_api_port|default(i2_api_port) }}
    i2_api_host: >-
      {{ hostvars[item].i2_api_host|default(hostvars[item].ansible_facts.default_ipv4.address) }}
    i2_hostname: >-
      {{ hostvars[item].i2_hostname|default(hostvars[item].ansible_fqdn) }}
    i2_zonename: >-
      {{ hostvars[item].i2_zonename|default(hostvars[item].ansible_fqdn) }}
    i2_templates: >-
      {{ hostvars[item].i2_custom_templates|default({}) }}
    i2_objects: >-
      {{ hostvars[item].i2_custom_objects|default({}) }}
    i2_apply_rules: >-
      {{ hostvars[item].i2_custom_apply_rules|default({}) }}
  run_once: True
  delegate_facts: True
  delegate_to: "{{ item }}"
  loop: >-
    {{ groups[i2_master_group]|default([])
    + groups[i2_satellite_group]|default([])
    + groups[i2_agent_group]|default([]) }}

- name: Determine peer nodes
  set_fact:
    i2_peer_nodes: >-
      {{ hostvars | dict2items
      | json_query("[?value.i2_zonename==" + "'" + hostvars[item].i2_zonename + "'].key")
      | sort }}
  run_once: True
  delegate_facts: True
  delegate_to: "{{ item }}"
  loop: >-
    {{ groups[i2_master_group]|default([])
    + groups[i2_satellite_group]|default([])
    + groups[i2_agent_group]|default([]) }}

- name: Determine parent and child nodes
  set_fact:
    i2_child_nodes: >-
      {{ hostvars | dict2items
      | json_query("[?value.i2_parent_zone==" + "'" + hostvars[item].i2_zonename + "'].key")
      | difference(hostvars[item].i2_peer_nodes)
      | sort }}
    i2_parent_nodes: >-
      {%- if hostvars[item].i2_parent_zone is defined -%}
      {{ hostvars | dict2items
      | json_query("[?value.i2_zonename==" + "'" + hostvars[item].i2_parent_zone + "'].key")
      | difference(hostvars[item].i2_peer_nodes)
      | sort
      }}
      {%- else %}[]{% endif -%}
  run_once: True
  delegate_facts: True
  delegate_to: "{{ item }}"
  loop: >-
    {{ groups[i2_master_group]|default([])
    + groups[i2_satellite_group]|default([])
    + groups[i2_agent_group]|default([]) }}

- name: Determine satellite zones
  set_fact:
    i2_satellite_zones: >-
      {{ groups[i2_satellite_group]|default([]) | map('extract', hostvars, 'i2_zonename' )
      | unique
      | sort }}

- name: Determine child zones
  set_fact:
    i2_child_zones: >-
      {{ hostvars[item].i2_child_nodes | map('extract', hostvars, 'i2_zonename' )
      | unique
      | sort }}
    i2_child_satellite_zones: >-
      {{ hostvars[item].i2_child_nodes | map('extract', hostvars, 'i2_zonename' )
      | unique
      | intersect(i2_satellite_zones)
      | sort }}
  run_once: True
  delegate_facts: True
  delegate_to: "{{ item }}"
  loop: >-
    {{ groups[i2_master_group]|default([])
    + groups[i2_satellite_group]|default([])
    + groups[i2_agent_group]|default([]) }}

- name: Check if Client Certificates exist
  become: yes
  stat:
    path: "{{ i2_pki_file }}"
  register: client_certificate

- name: Check if Client Certificate is signed by our CA
  become: yes
  openssl_certificate_info:
    path: "{{ i2_pki_file }}"
  register: client_certificate
  when: not i2_master and client_certificate.stat.exists

- name: Set certificate authority fact
  set_fact:
    i2_certificate_signed_by_ca: yes
  when:
    - client_certificate.issuer is defined
    - "'Icinga CA' == client_certificate.issuer.commonName"
    - "i2_hostname == client_certificate.subject.commonName"

- name: Icingaweb2 (Redhat) - Check if SELinux is enabled
  command: /usr/sbin/getenforce
  register: selinux
  when: ansible_os_family == 'RedHat'
